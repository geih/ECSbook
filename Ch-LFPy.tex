\chapter{\ehtxt{Numerical} schemes for computing extracellular potentials}
\label{sec:LFPy}
\ghnote{Torbjorn/Espen will write most this.}
\ghnote{La inn forslag til intro her:}

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

The \ehtxt{established \sout{standard}} way of computing extracellular potentials is to use a two-step multicompartment + volume conduction (MC+VC) scheme, 
which can be summarized as: 

\begin{itemize}
\item {\bf Step 1:} Compute the electrical activity of neurons using a the multicompartment (MC) framework presented in Chapter \ref{sec:Neuron}, assuming that it is unaffected by whatever goes on in the extracellular space. 
\item {\bf Step 2:} Compute the extracellular potential $\phi$ resulting from the neural transmembrane currents computed in step 1, using Volume Conductor (VC) theory (Chapters \ref{sec:VC}-\ref{sec:Sigma}). 
\end{itemize}

The MC+VC scheme is not self-consistent, since Step 1 computes the neurodynamics under the assumption that $\phi$ is \ehtxt{unaffected by transmembrane currents \sout{zero (grounded extracellular space)}}, 
and Step 2 uses this neurodynamics to compute a non-zero extracellular potential. 
\ehnote{I wonder if we should elaborate more on pt. 1: It is entirely possible to impose potentials different from zero and time varying with the current scheme and simultaneously estimate transmembrane currents. The main problem is that cable theory is 1D while real neurons are 3D (with the exception of structures such as axonal tracts).
Self-ephaptic effects should be entirely possible to account for using standard methods (NEURON) for cable models with 1D geometry (at least that's what I think!).}
There exist more complete and consistent schemes that account for both the ephaptic effects from $\phi$ on neurodynamics as well as for effects of ion concentration dynamics on neuronal activity of extracelluar potentials. In general, these more complete schemes require numerical simulations of both the neural and extracellular dynamics using finite element or finite difference methods, and are very computationally expensive.

In most scenarios, ephaptic effects from extracellular potentials on neurodynamics are small, and ion concentrations tend to stay close to baseline. When this is true, the simplifying approximations applied in the two-step scheme do not critically affect the accuracy of its predictions. As the MC+VC scheme is far more computationally efficient than any of the more complete schemes, it remains the gold standard for computing $\phi$ in large population models of neurons mimicking physiologically realistic scenarios. Also, designated software has been developed that makes it easy to perform simulations using the two-step-procedure. Therefore, the simulations in the application part of this book (Part 2) will predominantly be based on on the MC+VC-framework.

When aiming to make realistic simulations of extracellular potentials, one might need to simulate large networks containing thousands of neurons. This is computationally demanding, even on an efficient scheme like MC+VC. 
\ehnote{Computational demands are linearly dependent on the total number of compartments, so this a "simple" problem to solve, just scale up your computer capability accordingly.}
As we showed in Chapter \ref{sec:VC}, 
VC theory gave us \ehtxt{linear} analytical expression\ehtxt{s} for $\phi$ as a direct function of the neural current sources (Step 2), meaning that it is \ehtxt{usually} the simulations of the neurodynamics (Step 1) which is the bottleneck in the simulation. Below, we present computational schemes for the standard MC+VC approach, based on multicompartment neural models (Section \ref{sec:Schemes:LFPy}), and follow up with two strategies that may be applied to reduce the computational cost when computing the neurodynamics (Sections \ref{sec:Schemes:HybridLFPy}-\ref{sec:Schemes:KernelLFPy}). We end the chapter with a brief introduction of an alternative, and self-consistent framework (Section \ref{sec:VC:EMI}).

\ehnote{For meg gir det mer mening og organisere dette i reduksjonistisk rekkefoelge: (1) self-consistent; (2) MC+VC; (3) point-neuron spiking + MC + VC; (4) firing-rate + MC + VC. 
Men uansett, burde ikke dette vaere del av "Applications"-kapitlet? Punkt 3 og 4 endrer i prinsippet ingenting med MV+VC formalismen - man disassosierer bare simulering av nettverksaktivitet (korrelasjoner) fra (MC+VC)-formalismen.}



%%%%%%

\section{\red{TVN/EH: Neurodynamics based on multicompartmental neuron models}}
\label{sec:Schemes:LFPy}
\index{Multicompartment models}

\ehnote{gammalt:}
The standard way - what LFPy was originally designed for \cite**{Hagen2018}.
Same trick used earlier \cite**{Holt1999}.
Same kind of thinking with LFPsim: \cite**{parasuram2016}

\ehnote{nytt:}


\ehnote{main points:}
\begin{itemize}
\item Numerical solution of the cable equation and state variables for channels, synapses etc. (in short)
\item Estimating the axial and transmembrane currents for each compartment
\item Applying a linear forward model to transmembrane/axial currents
\end{itemize}

Most models aiming to mimic the dynamics of a particular neuron or neural system except the simplest ball and stick like models are too complex to be solved analytically (cf. \Fref{sec:Neuron}). 
Thus the set of partial differential equations (PDEs) and initial conditions representing voltage- and concentration-dependent ion channels, synapses, plasticity, neuronal geometry etc. of the full model will have to be solved numerically on computers. 
The numerical solution of geometrically detailed cable models entails a discretization of the geometry into multiple compartments (hence MC) wherein the states of variables and their derivatives are estimated on a temporal grid which may be fixed or irregular.
While one could utilize general-purpose numerical solvers in order to compute resulting voltage fluctuations, transmembrane currents or axial currents, 
a more feasible approach is utilization of one of several different software tools tailored for this purpose that have been developed in the past.
Such software greatly simplify the process of specifying the phenomenological or biophysically detailed model and choosing the appropriate numerical schemes for solving the resulting set of PDEs. 
Such tools will also by default usually account for one of the main assumptions of standard cable theory, that is, 
the spatial variation in membrane voltage across the entire morphology can be computed independently of any effect 
transmembrane currents may have on the extracellular potential immediately outside the compartments (see chapter \ehnote{crossref} for details).


The NEURON simulation environment \cite{Hines1997} (\href{https://neuron.yale.edu}{https://neuron.yale.edu}) presently remains a prevalent choice for empiric-based simulations of MC neuron models as it supports both Windows-, 
linux- and unix-based operating systems including MacOS, 
and can be used with a GUI or in a programmatic fashion on laptops, desktop computers and in parallel on large-scale high-performance computing (HPC) facilities. 
NEURON is also utilized as a simulator backend for other higher-level software such as PyNN, NetPyne, BMTK, LFPy \ehnote{add citations} etc.
Alternatives to NEURON with partially overlapping feature sets have been developed in the past in form of MOOSE \ehnote{add citation, URL} and GENESIS \ehnote{add citation, URL}, 
while software tailored for point-like neuron models such as Brian \ehnote{add citation, URL} recently received support for biophysically detailed MC neuron models.
Another effort receiving funding from the EU Human Brain Project, 
named Arbor \ehnote{add citation, URL}, 
aims to develop MC neuron simulation software from the ground up in order to fully exploit modern high-performance libraries and next generation hardware in the form of graphical processing units (GPUs) and massively parallel HPC facilities. 

Here we will refrain from going into details on the inner workings of the above software tools, 
but reiterate that both axial currents and transmembrane currents can be estimated if the set of PDEs can be solved numerically for the membrane voltage of the MC neuron model(s). 
The axial and transmembrane currents of a non-branching piece of cable is given in continuous form by 
%
\begin{eqnarray}
I_\mathrm{i}(x,t) &=& - \frac{1}{r_\mathrm{i}} \frac{\partial V(x, t)}{\partial x} \text{~and} \\
i_\mathrm{m}(x, t) &=& - \frac{\partial I_\mathrm{i} (x, t)}{\partial x} = \frac{1}{r_\mathrm{i}} \frac{\partial^2 V(x,t)}{\partial x^2}\text{,}
\label{eq:LFPy_ia_im_continuous}
\end{eqnarray}
%
where the intracellular resistance per unit length $r_i=4R_\mathrm{a}/\pi d^2$ in unit $\Omega / m$. 
Here, $R_\mathrm{a}$  and $d$ is the axial resistivity and diameter of the compartment, respectively.  
For spatially discretized cable models these currents can be estimated on a per-compartment basis by the central difference approximation as: 
%
\begin{eqnarray}
I_\mathrm{i}(x, t) &\overset{h>0}{\approx}& - \frac{1}{r_\mathrm{i}} \frac{V(x+\frac{h}{2}, t) - V(x-\frac{h}{2}, t)}{h} \nonumber \\
		  &\overset{L=h}{=}& \frac{\pi d^2}{4 R_\mathrm{a}} \frac{V(x - \frac{h}{2}, t) - V(x + \frac{h}{2}, t)}{h}
\label{eq:LFPy_ia_discrete
\end{eqnarray}
%
and 
%
\begin{eqnarray}
I_\mathrm{m}(x, t) &\overset{h>0}{\approx}& \frac{1}{r_\mathrm{i}} \frac{V(x + \frac{h}{2}, t) - V(x, t)+ V(x - \frac{h}{2}, t)}{h^2 / 4} \nonumber \\
		&\overset{L=h}{=}& \frac{\pi d^2}{R_\mathrm{a}} \frac{V(x + \frac{L}{2}, t) - V(x, t) + V(x - \frac{L}{2}, t)}{L^2}.
\label{eq:LFPy_im_discrete}
\end{eqnarray} 
%
Here, the discretization constant $h$ is set equal to the compartment length $L$ 
and the spatial location $x$ corresponds to its midpoint. 
The diameter is typically assumed to be of fixed. 
\ehnote{True for NEURON, but not for Arbor which adapts a FDM type scheme in 1D.}
We next outline how the 



\section{\red{TVN/EH: Neurodynamics from point-neuron models}}
\label{sec:Schemes:HybridLFPy}
\index{Point neuron model}

\ehnote{gammalt:}
Point neuron models do not generate extracellular fields. Sad, because simulations would be much faster if we could use point neuron models. Trick to do this, Hybrid LFPy \cite**{Hagen2016}, Skaar et al (in revision)

\ehnote{nytt:}

\section{\red{EH: Neurodynamics using firing-rate models}}
\label{sec:Schemes:KernelLFPy}
\index{Firing rate model}

\ehnote{gammalt:}
Would make things even faster. Population firing-rate models  \cite**{Hagen2016}. Kernel trick (Ness et al, on-going project)

\ehnote{nytt:}




\section{\blue{GH: Self-consistent scheme for intra- and extracellular potentials} }
\label{sec:VC:EMI}
\index{Ephaptic effects}
Ephaptic effects refers to the phenomenon where the extracellular potential affects the membrane potential dynamics of neurons. The possible importance of ephaptic effects has been the topic of many studies, addressing in various ways how extracellular electric fields may affect neuronal firing or signal propagation in axons (see e.g., \cite**{clark1970,Rall1977,Holt1999,Bokil2001,anastassiou2010,anastassiou2015,Goldwyn2016,capllonch2020,ruffini2020}). 

Most of these studies have been based on some simplified approximations as to how evoked fields from one neuron affects other neurons, and less focus has been put on how the presence of ephaptic effects will affect the extracellular potential itself. Rigorous modeling of this, requires that the intra- and extracellular dynamics are modeled simultaneously on a unified framework based on VC theory. Such a framework exists \cite**{Krassowska1994,Agudelo-Toro2013,Tveito 2017}, and was in a recent publication referred to as the extracellular-membrane-intracellular (EMI) framework \cite**{Tveito2017}. 

We here only describe very briefly the essence of the EMI framework. It is based on (Ohmic) current conservation in the intra- and extracelluar spaces, so that:
\begin{equation}
\nabla \cdot \sigma_r \nabla \phi_r = 0,
\label{eq:VC:EMI}
\end{equation}
where $r$ takes the indexes $i$ (intracellular space) or $e$ (extracellular space). The intra- and extracellular dynamics are coupled through suitable boundary condictions at the membrane, making sure that a current \textit{entering} the membrane (normal component) at one side of the membrane, is constrained to be identical to the current \textit{leaving} the membrane (negative normal component) on the opposite side \cite**{Krassowska1994}. These entering and leaving currents are in turn determined by a set of mechanisms that jointly determine the transmembrane current $I_m$. In previous numerical implementations of the EMI framework, the membrane currents were modeled with Hodgkin-Huxley like kinetics \cite**{Agudelo-Toro2013,Tveito2017}. 

Compared to the two-step MC+VC framework, EMI has the disadvantage that it is computationally expensive. In the MC + VC scheme, which uses volume conduction modeling only for the extracellular space, $\phi_e$ can be computed as an analytical function of the transmembrane neural currents (cf. Chapter \ref{sec:VC}). Using EMI, analytical examples of solutions can only be obtained for idealized scenarios \cite**{Krassowska1994}, while general EMI applications require that both the intra- and extracellular spaces are spatially resolved and their dynamics computed on a numerical framework \cite**{Agudelo-Toro2013,Tveito2017}. 

Using EMI to simulate larger systems with realistic morphologies would probably exceed the capacity of today's computers. However, EMI has been used to perform a systematic exploration of the inaccuracies induced when ignoring ephaptic effects in a small system of neurons represented with stylized geometries  \cite**{Tveito2017}. 

There exist even more advanced framework than EMI, which, in addition to accounting for ephaptic effects, also account for effects of changing ion concentrations. We will talk briefly of this in Chapter \ref{sec:Eldiff}, where we consider electrodiffusive transports in brain tissue.