\chapter{\ehtxt{Numerical} schemes for computing extracellular potentials}
\label{sec:LFPy}
\ghnote{Torbjorn/Espen will write most this.}
\ghnote{La inn forslag til intro her:}

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

The \ehtxt{established \sout{standard}} way of computing extracellular potentials is to use a two-step multicompartment + volume conduction (MC+VC) scheme, 
which can be summarized as: 

\begin{itemize}
\item {\bf Step 1:} Compute the electrical activity of neurons using a the multicompartment (MC) framework presented in Chapter \ref{sec:Neuron}, assuming that it is unaffected by whatever goes on in the extracellular space. 
\item {\bf Step 2:} Compute the extracellular potential $\phi$ resulting from the neural transmembrane currents computed in step 1, using Volume Conductor (VC) theory (Chapters \ref{sec:VC}-\ref{sec:Sigma}). 
\end{itemize}

The MC+VC scheme is not self-consistent, since Step 1 computes the neurodynamics under the assumption that $\phi$ is \ehtxt{unaffected by transmembrane currents \sout{zero (grounded extracellular space)}}, 
and Step 2 uses this neurodynamics to compute a non-zero extracellular potential. 
\ehnote{I wonder if we should elaborate more on pt. 1: It is entirely possible to impose potentials different from zero and time varying with the current scheme and simultaneously estimate transmembrane currents. The main problem is that cable theory is 1D while real neurons are 3D (with the exception of structures such as axonal tracts).
Self-ephaptic effects should be entirely possible to account for using standard methods (NEURON) for cable models with 1D geometry (at least that's what I think!).}
There exist more complete and consistent schemes that account for both the ephaptic effects from $\phi$ on neurodynamics as well as for effects of ion concentration dynamics on neuronal activity of extracelluar potentials. In general, these more complete schemes require numerical simulations of both the neural and extracellular dynamics using finite element or finite difference methods, and are very computationally expensive.

In most scenarios, ephaptic effects from extracellular potentials on neurodynamics are small, and ion concentrations tend to stay close to baseline. When this is true, the simplifying approximations applied in the two-step scheme do not critically affect the accuracy of its predictions. As the MC+VC scheme is far more computationally efficient than any of the more complete schemes, it remains the gold standard for computing $\phi$ in large population models of neurons mimicking physiologically realistic scenarios. Also, designated software has been developed that makes it easy to perform simulations using the two-step-procedure. Therefore, the simulations in the application part of this book (Part 2) will predominantly be based on on the MC+VC-framework.

When aiming to make realistic simulations of extracellular potentials, one might need to simulate large networks containing thousands of neurons. This is computationally demanding, even on an efficient scheme like MC+VC. 
\ehnote{Computational demands are linearly dependent on the total number of compartments, so this a "simple" problem to solve, just scale up your computer capability accordingly.}
As we showed in Chapter \ref{sec:VC}, 
VC theory gave us \ehtxt{linear} analytical expression\ehtxt{s} for $\phi$ as a direct function of the neural current sources (Step 2), meaning that it is \ehtxt{usually} the simulations of the neurodynamics (Step 1) which is the bottleneck in the simulation. Below, we present computational schemes for the standard MC+VC approach, based on multicompartment neural models (Section \ref{sec:Schemes:LFPy}), and follow up with two strategies that may be applied to reduce the computational cost when computing the neurodynamics (Sections \ref{sec:Schemes:HybridLFPy}-\ref{sec:Schemes:KernelLFPy}). We end the chapter with a brief introduction of an alternative, and self-consistent framework (Section \ref{sec:VC:EMI}).

\ehnote{For meg gir det mer mening og organisere dette i reduksjonistisk rekkefoelge: (1) self-consistent; (2) MC+VC; (3) point-neuron spiking + MC + VC; (4) firing-rate + MC + VC. 
Men uansett, burde ikke dette vaere del av "Applications"-kapitlet? Punkt 3 og 4 endrer i prinsippet ingenting med MV+VC formalismen - man disassosierer bare simulering av nettverksaktivitet (korrelasjoner) fra (MC+VC)-formalismen.}



%%%%%%

\section{\ehnote{}\ehtxt{Forward-model predictions from multicompartment neuron models}}
\label{sec:Schemes:LFPy}
\index{Multicompartment models}


Most models aiming to mimic the dynamics of a particular neuron or neural system except the simplest ball and stick like models are too complex to be solved analytically (cf. \Fref{sec:Neuron}). 
Thus the set of partial differential equations (PDEs) and initial conditions representing voltage- and concentration-dependent ion channels, synapses, plasticity, neuronal geometry etc. of the full model will have to be solved numerically on computers. 
The numerical solution of geometrically detailed cable models entails a discretization of the geometry into multiple compartments (hence MC) wherein the states of variables and their derivatives are estimated on a temporal grid which may be fixed or irregular.
While one could utilize general-purpose numerical solvers in order to compute resulting voltage fluctuations, transmembrane currents or axial currents, 
a more feasible approach is utilization of one of several different software tools tailored for this purpose that have been developed in the past.
Such software greatly simplify the process of specifying the phenomenological or biophysically detailed model and choosing the appropriate numerical schemes for solving the resulting set of PDEs. 
Such tools will also by default usually account for one of the main assumptions of standard cable theory, that is, 
the spatial variation in membrane voltage across the entire morphology can be computed independently of any effect 
transmembrane currents may have on the extracellular potential immediately outside the compartments (see chapter \Fref{chap:Neuron} for details).


The NEURON simulation environment\footnote{\href{https://neuron.yale.edu}{https://neuron.yale.edu}} \cite{Hines1997} presently remains a prevalent choice for empiric-based simulations of MC neuron models as it supports both Windows-, 
linux- and unix-based operating systems including MacOS, 
and can be used with a GUI or in a programmatic fashion on laptops, desktop computers and in parallel on large-scale high-performance computing (HPC) facilities. 
NEURON is also utilized as a simulator backend for other higher-level software such as 
PyNN\footnote{\href{https://neuralensemble.org/PyNN/}{https://neuralensemble.org/PyNN/}} \cite{Davison2008}, 
NetPyne\footnote{\href{http://www.netpyne.org}{http://www.netpyne.org}} \cite{Dura_Bernal_2019}, 
BMTK\footnote{\href{https://alleninstitute.github.io/bmtk/}{https://alleninstitute.github.io/bmtk/}} \cite{Dai2020}, 
LFPy\footnote{\href{https://lfpy.readthedocs.io}{https://lfpy.readthedocs.io}} \cite{Linden2014,Hagen2018} etc.
Alternatives to NEURON with partially overlapping feature sets have been developed in the past in form of 
MOOSE\footnote{\href{https://moose.ncbs.res.in}{https://moose.ncbs.res.in}} \cite{Bhalla2008} and 
GENESIS\footnote{\href{http://genesis-sim.org}{http://genesis-sim.org}} \cite{Bower1998}, 
while software tailored for point-like neuron models such as 
Brian\footnote{\href{https://briansimulator.org/}{https://briansimulator.org/}} \cite{Stimberg2019} recently received support for biophysically detailed MC neuron models.
Another effort receiving funding from the EU Human Brain Project, 
named Arbor\footnote{\href{https://arbor.readthedocs.io}{https://arbor.readthedocs.io}} \cite{Akar2019}, 
aims to develop MC neuron simulation software from the ground up in order to fully exploit modern high-performance libraries and next generation hardware in the form of graphical processing units (GPUs) and massively parallel HPC facilities. 


\subsubsection{Predicting axial and transmembrane currents}
\label{chap:LFPy_Ia_Im}

Here we will refrain from going into details on the inner workings of the above software tools, 
but reiterate that both axial currents and transmembrane currents can be estimated if the set of PDEs can be solved numerically for the membrane voltage of the MC neuron model(s). 
The membrane voltages of MC neuron models are typically assumed to be `measured' at the center of each compartment. 
The axial and transmembrane currents of a non-branching piece of cable is given in continuous form by 
%
\begin{eqnarray}
I_\mathrm{a}(x,t) &=& - \frac{1}{r_\mathrm{i}} \frac{\partial V_\mathrm{m}(x, t)}{\partial x} \text{~and} \\
i_\mathrm{m}(x, t) &=& - \frac{\partial I_\mathrm{a} (x, t)}{\partial x} = \frac{1}{r_\mathrm{i}} \frac{\partial^2 V_\mathrm{m}(x,t)}{\partial x^2}~,
\label{eq:LFPy_ia_im_continuous}
\end{eqnarray}
%
where the intracellular resistance per unit length $r_\mathrm{i}=4R_\mathrm{a}/\pi d^2$ can be given with unit \si{\ohm/\metre}. 
Here, $R_\mathrm{a}$  and $d$ is the axial resistivity (\si{\ohm\metre}) and diameter (\si{\metre}) of the dendritic cable model, respectively (cf. \Fref{chap:Neuron}).  
The unit for axial currents $I_\mathrm{a}(x, t)$ is \si{\ampere}, 
while the transmembrane current is per unit length (\si{\ampere/\metre}).
The location $x$ denotes the position along the piece of cable in one dimension (the cable equation is by definition 1D even if the different parts of a neuron may be assigned locations in 3D space). 

For spatially discretized cable models the axial currents can be estimated on a per-compartment basis with midpoint location $x_j$ by the central difference approximation as: 
%
\begin{eqnarray}
I_\mathrm{a}(x_j, t) &\overset{h>0}{\approx}& - \frac{1}{r_\mathrm{i}} \frac{V_\mathrm{m}(x_j+\frac{h}{2}, t) - V_\mathrm{m}(x_j-\frac{h}{2}, t)}{h} \nonumber \\
		  &\overset{L_j=h}{=}& - \frac{\pi d_j^2}{4 R_\mathrm{a}} \frac{V(x_j - \frac{L_j}{2}, t) - V_\mathrm{m}(x + \frac{L_j}{2}, t)}{L_j} ~.
\label{eq:LFPy_ia_discrete}
\end{eqnarray}
%
Here, the discretization constant $h$ is set equal to the compartment length $L_j$. 
Its diameter is typically assumed to be constant, 
and the cylindrical compartment is a straight along its length axis. 
\ehnote{True for NEURON, but not for Arbor which adapts a FDM type scheme in 1D corresponding to electric compartments made up by series of conical frusta.}
Note that it is possible to swap the central difference approximation 
by the forward and  backward difference approximation estimating axial currents for each half-compartment respectively as in \cite{Hagen2018}, 
but we will not go into further detail here. 
 
We next outline how the membrane potential can be estimated at the end points of each compartment $x \in \{x_j-L_j/2, x_j+L_j/2\}$, 
which may connected to none, one or several other end points of other compartments, 
when the neural simulation software returns the midpoint potential $V_\mathrm{m}(x_j, t)$ for every $j \in \{1, \cdots, N \}$ compartment. 
For terminating compartments (i.e., one or both ends has no connecting compartments and sealed ends) we may define
%
\begin{eqnarray}
V_\mathrm{m}(x_j - L_j/2, t) &\equiv& V_\mathrm{m}(x_j, t)~\mathrm{and/or} \nonumber \\
V_\mathrm{m}(x_j + L_j/2, t) &\equiv& V_\mathrm{m}(x_j, t)~, \nonumber
\end{eqnarray} 
%
depending on which end(s) has no electric connections. 
(This step effectively utilize the forward/backward difference approximation to first derivatives but only to terminating compartments. 
If both ends terminate, the axial current will be zero as the voltage is assumed to be iso-potential along the compartment axis.)

For a number $N$ child compartments connected at the end point location $(x_j+L_j/2)$ of the parent compartment (\Fref{fig:LFPy_circuits}C) the potential can be computed from the parent- and child-compartment mid-point potentials as \cite{Hagen2018}

\begin{equation}
V_\mathrm{m}(x_j+L_j/2, t) = \frac{\sum_{n=0}^N V_\mathrm{m}(x_{j+n}, t) / R_{j+n}}{\sum_{n=0}^N 1 / R_{j+n}}~, 
\label{eq:LFPy_V_connect_point}
\end{equation}
% 
where the connecting node to mid point resistances
%
\begin{eqnarray}
R_{j+n} &=& \frac{2 R_\mathrm{a}L_{j+n}}{\pi d_{j+n}^2} ~.
\end{eqnarray} 

For child compartments connecting to the mid point of the parent compartment, 
the corresponding potential at the branch point seen by any number of child segments is per definition the same as the mid point potential of the parent, that is, 
\begin{equation}
V_\mathrm{m}(x_{j+n}-L_{j+n} / 2, t) \equiv V_\mathrm{m}(x_j, t) ~.
\end{equation} 

Up to this point, we have provided the basic `machinery' needed in order to compute the discrete axial currents in a MC neuron model, 
independently of specific and non-specific ion-channel currents, synaptic currents, capacitive currents etc. which may be present in the membrane of biophysically detailed MC neuron models. 
By our application of the central difference approximation to the first derivative, 
it is in these derivations then implicitly assumed that the axial current is approximately constant along the entire length of the compartment, 
which in turn imply that the the membrane voltage varies approximately linearly with position. 
The naive computational neuroscientist should remind her/himself that this assumption is likely to be violated if the spatial discretization chosen for the model neuron(s) is too coarse. 
%
Also the transmembrane currents may be estimated on a per-compartment basis in a similar manner using the central difference approximation to the 2nd derivative as 
%
\begin{eqnarray}
i_\mathrm{m}(x_j, t) &\overset{h>0}{\approx}& \frac{1}{r_\mathrm{i}} \frac{V_\mathrm{m}(x_j + \frac{h}{2}, t) - V_\mathrm{m}(x_j, t)+ V_\mathrm{m}(x_j - \frac{h}{2}, t)}{h^2 / 4} \nonumber \\
		&\overset{L_j=h}{=}& \frac{\pi d_j^2}{R_\mathrm{a}} \frac{V_\mathrm{m}(x_j + \frac{L_j}{2}, t) - V_\mathrm{m}(x_j, t) + V_\mathrm{m}(x_j - \frac{L_j}{2}, t)}{L_j^2} ~.
\label{eq:LFPy_im_discrete}
\end{eqnarray} 


This machinery may appear as a bit of a hurdle to implement for the purpose of computing extracellular potentials or magnetic signals, 
but thankfully MC neuron modeling software such as NEURON provides native support for computing the transmembrane current (\si{\ampere}) and/or transmembrane current density per surface membrane area (\si{\ampere/\metre^2}) for each compartment. 
Dependent on the implementation in the neural simulation software, 
a more direct measure of the transmembrane currents is indeed computing the sum over all capacitive currents, specific and non-specific ion-channel currents, synapse currents etc. (cf. \Fref{chap:Neuron}). 
% 
The current state is however a bit more dire with regards to predicting axial current per compartment (or half-compartment \cite{Hagen2018}). 
For now, we will emphasize that typical extracellular measures of extracellular electric or even magnetic signals can be derived from the transmembrane currents alone. 

\begin{figure}[!ht]
\begin{center}
\includegraphics[width=0.8\textwidth]{Figures/Ch-LFPy/circuits.png}
\end{center}
\caption{\textbf{Equivalent circuits for computing axial and transmembrane currents}. 
({\bf A}) One-compartment cable model with sealed ends. 
({\bf B}) Continuous piece of MC cable model.  
({\bf C}) MC cable model with branch point.}
\label{fig:LFPy_circuits}
\end{figure}


Up to this point, the attentive reader of this chapter may have noticed that the axial currents (and transmembrane currents for that matter) is \textit{linearly} dependent on the midpoint membrane voltages of the MC model. 
Thus, the full set of operations involved in computing the full set of axial current magnitudes can be rewritten as a linear combination on the form
%
\begin{eqnarray}
\begin{bmatrix}
I_\mathrm{a}(\mathbf{r}_1, t)\\
I_\mathrm{a}(\mathbf{r}_2, t)\\
\vdots \\
I_\mathrm{a}(\mathbf{r}_N, t)
\end{bmatrix}
&=& \mathbf{A}^{-1} 
\begin{bmatrix}
V_\mathrm{m}(\mathbf{r}_1, t)\\
V_\mathrm{m}(\mathbf{r}_2, t)\\
\vdots \\
V_\mathrm{m}(\mathbf{r}_N, t)\\
\end{bmatrix} ~,
\label{eq:LFPy_linear_combination}
\end{eqnarray}
%
where $\mathbf{r}_j$ denotes the midpoint location of compartment $j$ while the elements of the shape $(N, N)$ matrix $\mathbf{A}$ effectively corresponds to intracellular resistances and the specific connectivity between compartments
(recall Ohm's law for the current $I$ across a resistor $R$ given a voltage difference $\Delta V$: $I=R^{-1} \Delta V$). 
$\mathbf{A}$ may in practise be non-invertible, 
but it can be demonstrated that a matrix $\mathbf{G}\equiv \mathbf{A}^{-1}$ can be computed directly. 
%
For a two-compartment model connecting the end point of the root (parent) compartment with the start point of the child compartment, 
it can be shown with some arithmetics that the axial current in each compartment is \ehnote{derived in /sympycodes/Ch6\_calc\_iaxial.ipynb}
%
\begin{equation}
I_\mathrm{a}(\mathbf{r}_1, t) = I_\mathrm{a}(\mathbf{r}_2, t) = 
	- \frac{\pi d_{1}^{2} d_{2}^{2} \left(V_\mathrm{m}(\mathbf{r}_1, t) - V_\mathrm{m}(\mathbf{r}_2, t) \right)}{4 R_{a} \left(L_{1} d_{2}^{2} + L_{2} d_{1}^{2}\right)} ~,
\end{equation}
%
which can be rewritten as the linear combination
% 
\begin{eqnarray}
\begin{bmatrix}
I_\mathrm{a}(\mathbf{r}_1, t)\\
I_\mathrm{a}(\mathbf{r}_2, t)
\end{bmatrix} 
=
- \frac{\pi d_{1}^{2} d_{2}^{2}}{4 R_{a} \left(L_{1} d_{2}^{2} + L_{2} d_{1}^{2}\right)}
\begin{bmatrix}
1 & -1 \\ 
1 & -1 
\end{bmatrix}
\begin{bmatrix}
V_\mathrm{m}(\mathbf{r}_1, t) \\
V_\mathrm{m}(\mathbf{r}_2, t) ~, 
\end{bmatrix}
\end{eqnarray}
%
that is, similar to \Fref{eq:LFPy_linear_combination}. 
We encourage the interested reader of this book to show that the same approach hold for other model configurations, such 
as 3-compartment models without and with branching points.  

So far the axial currents is represented as a scalar field. 
For some applications, such as computing the magnetic field $\mathbf{H}(\mathbf{r}, t)$, 
the axial currents can be represented as a vector field by multiplication with the path vectors along the center axis of each compartment:
%
\begin{equation}
\mathcal{I}_\mathrm{a}(t) \equiv
\begin{bmatrix}
\mathbf{I}_\mathrm{a}(\mathbf{r}_1, t)\\
\mathbf{I}_\mathrm{a}(\mathbf{r}_2, t)\\
\vdots \\
\mathbf{I}_\mathrm{a}(\mathbf{r}_N, t)
\end{bmatrix}
=
\begin{bmatrix}
I_\mathrm{a}(\mathbf{r}_1, t) \mathbf{d}_1 \\
I_\mathrm{a}(\mathbf{r}_2, t) \mathbf{d}_2 \\
\vdots \\
I_\mathrm{a}(\mathbf{r}_N, t) \mathbf{d}_N
\end{bmatrix} ~,
\end{equation}
%
For compactness we introduced $\mathbf{d}_j=\mathbf{r}_{\mathrm{f}j} - \mathbf{r}_{\mathrm{i}j}$, 
where $\mathbf{r}_{\mathrm{i}j}$ and $\mathbf{r}_{\mathrm{f}j}$ denotes the start and end point coordinates of compartment $j$. 
Consistent with the point-source formalism (cf. \Fref{sec:VC:pointsource}), 
we let the `location' of each axial current be the mid-point $\mathbf{r}_j$ of each cylindrical compartment $j$. 
In a similar manner we will represent the total transmembrane current per compartment as a matrix
\begin{equation}
\mathbf{I}_\mathrm{m}(t) = 
\begin{bmatrix}
I_\mathrm{m}(\mathbf{r}_1, t) \\
I_\mathrm{m}(\mathbf{r}_2, t) \\
\vdots \\
I_\mathrm{m}(\mathbf{r}_N, t)
\end{bmatrix}
=
\begin{bmatrix}
i_\mathrm{m}(\mathbf{r}_1, t) \Vert \mathbf{d}_1 \Vert \\
i_\mathrm{m}(\mathbf{r}_2, t) \Vert \mathbf{d}_2 \Vert \\
\vdots \\
i_\mathrm{m}(\mathbf{r}_N, t) \Vert \mathbf{d}_N \Vert
\end{bmatrix} ~,
\end{equation}
under the assumption that the transmembrane current density $i_\mathrm{m}(x_j, t)$ is constant along the compartment axis. 
Here, $\Vert\mathbf{d}_j \Vert$ denotes the norm of $\mathbf{d}_j$. 
Note that $\mathcal{I}_\mathrm{a}(t)$ is a 3D tensor array with unit \si{\ampere \metre} and shape $(3, N, N_t)$, 
while $\mathbf{I}_\mathrm{m}(t)$ is a 2D matrix with unit \si{A} with shape $(N, N_t)$. 
$N_t$ is here the number of discrete time steps of the current segments.


%%%%%%%%%%%

\subsubsection{Application of linear volume conductor models for extracellular potentials and magnetic fields}

\ehnote{Make extracellular predictions $\mathbf{y}$ as linear systems $\mathbf{y} = \mathbf{Mx}$}

As derived from \textit{volume conductor theory} (\Fref{chap:VC}), 
the different electric and magnetic signals that can be computed from the electric activity of brain cells are \textit{linearly} dependent on either transmembrane currents or axial currents. 
Thus, some arbitrary signals $v(\mathbf{R}_i, t)$ in $M$ different spatial locations from the $N$ compartmental sources located at $r_j$ can be computed as 
%
\begin{eqnarray}
\begin{bmatrix}
v(\mathbf{R}_1, t) \\
v(\mathbf{R}_2, t) \\
\vdots \\
v(\mathbf{R}_M, t) 
\end{bmatrix}
&=& \mathbf{F}
\begin{bmatrix}
w(\mathbf{r}_1, t) \\
w(\mathbf{r}_2, t) \\
\vdots \\
w(\mathbf{r}_N, t)
\end{bmatrix} ~,
\end{eqnarray}
%
where $\mathbf{F}$ is a matrix with dimensions $(M, N)$ wherein each element $f_{ij}$ is the chosen forward solution mapping the contribution from each source to the corresponding measurement. 
A simple linear forward model mapping transmembrane currents of an $N$-compartment model to extracellular potentials in $M$ locations would be the point-source formalism, 
which models neuronal sources \textit{and} measurement sites as infinitesimally small points a conductive medium. 
The point-source formula (\Fref{eq:VC:pointsource}) results in 
%
\begin{equation}
f_{ij} = \frac{1}{4\pi\sigma_\mathrm{e}}\frac{1}{\Vert\mathbf{R}_i - \mathbf{r}_j\Vert}  ~.
\end{equation}
% 
The full linear system for obtaining the extracellular potential may then be written out as the linear combination
% 
\begin{equation}
\begin{bmatrix}
\phi(\mathbf{R}_1, t) \\
\phi(\mathbf{R}_2, t) \\
\vdots \\
\phi(\mathbf{R}_M, t) 
\end{bmatrix}
= \frac{1}{4\pi\sigma_\mathrm{e}}
\begin{bmatrix}
\frac{1}{\Vert\mathbf{R}_1 - \mathbf{r}_1\Vert} & \frac{1}{\Vert\mathbf{R}_1 - \mathbf{r}_2\Vert} & \cdots & \frac{1}{\Vert\mathbf{R}_1 - \mathbf{r}_N\Vert} \\
\frac{1}{\Vert\mathbf{R}_2 - \mathbf{r}_1\Vert} & \frac{1}{\Vert\mathbf{R}_2 - \mathbf{r}_2\Vert} & \cdots & \frac{1}{\Vert\mathbf{R}_2 - \mathbf{r}_N\Vert} \\
\vdots & \vdots & \cdots & \vdots \\
\frac{1}{\Vert\mathbf{R}_M - \mathbf{r}_1\Vert} & \frac{1}{\Vert\mathbf{R}_M - \mathbf{r}_2\Vert} & \cdots & \frac{1}{\Vert\mathbf{R}_M - \mathbf{r}_N\Vert}
\end{bmatrix}
\begin{bmatrix}
I_\mathrm{m}(\mathbf{r}_1, t) \\
I_\mathrm{m}(\mathbf{r}_2, t) \\
\vdots \\
I_\mathrm{m}(\mathbf{r}_N, t)
\end{bmatrix} ~.
\end{equation}
%
Similarly, for line sources (\Fref{eq:VC:linesource}), the elements of $\mathbf{F}$ may be calculated as
%
\begin{equation}
f_{ij} = \frac{1}{4\pi \sigma_\mathrm{e} \Delta s_{ij}} \log \left\Vert \frac{\sqrt{h_{ij}^2+\rho_{ij}^2}-h_{ij}}{\sqrt{\ell_i^2+\rho_{ij}^2}-\ell_{ij}} \right\Vert ~,
\label{eq:LFPy:linesources}
\end{equation}
%
where $\rho_{ij}$ is the distance perpendicular to line segment (compartment) $j$, 
$h_{ij}$ the longitudinal distance from the end of the segment
and $\ell_{ij} = \delta s_{ij} + h_{ij}$ the longitudinal distance from the start of the segment to some electrode contact located at $\mathbf{R}_i$. 

The approach is applicable also to other types of measurements which are linearly dependent on the transmembrane current sources, 
such as the current dipole moment (\Fref{eq:VC:dipole}). 
For computing the current dipole moment the mapping matrix' columns are simply
%
\begin{equation}
f_{j} = \mathbf{r}_j
= 
\begin{bmatrix}
x_j \\
y_j \\
z_j
\end{bmatrix} ~.
\end{equation}

Another example is computing the \textit{ground truth} current source density (CSD) \cite{Pettersen2008,Hagen2016,Hagen2017}, 
that is, assigning the contribution of different compartments' transmembrane current to $M$ different spatial domains $\Omega_j$ as 
%
\begin{equation}
f_{ij} = \frac{\Delta s_{ij\in \Omega_j}}{\Delta s_{ij} V_{\Omega_j}} ~,
\label{eq:LFPy:gtCSD}
\end{equation}
%
where $(\Delta s_{ij\in \Omega_j} / \Delta s_{ij}) \in [0, 1]$ denotes the fraction of the length of the segment within the domain $\Omega_j$ and 
$V_{\Omega_j}$ the volume of the spatial domain. 

The formalism also holds for higher-dimensional sources, that is, 
the set of axial currents $\mathcal{I}_\mathrm{a}$ which in the present context is represented by a 3D tensor array with shape $(3, N, N_t)$. 
To compute the magnetic field outside the neuron arising from axial currents one can build up the forward model matrix $\mathbf{F}$ element by element using the relevant Biot-Savart law \cite{Blagoev2007,Hagen2018}
%
\begin{equation}
f_{ij} = \frac{\mu_0}{4\pi} \frac{\Vert \mathbf{d}_j \Vert \times (\mathbf{R}_i - \mathbf{r}_j) }{\Vert \mathbf{R}_i - \mathbf{r}_j \Vert^3}
\end{equation}
\ehnote{need to doublecheck}




\ehnote{show code examples from LFPykit?}



\section{\red{TVN/EH: Neurodynamics from point-neuron models}}
\label{sec:Schemes:HybridLFPy}
\index{Point neuron model}

\ehnote{gammalt:}
Point neuron models do not generate extracellular fields. Sad, because simulations would be much faster if we could use point neuron models. Trick to do this, Hybrid LFPy \cite**{Hagen2016}, Skaar et al (in revision)

\ehnote{nytt:}

\section{\red{EH: Neurodynamics using firing-rate models}}
\label{sec:Schemes:KernelLFPy}
\index{Firing rate model}

\ehnote{gammalt:}
Would make things even faster. Population firing-rate models  \cite**{Hagen2016}. Kernel trick (Ness et al, on-going project)

\ehnote{nytt:}


%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

\section{\blue{GH: Self-consistent scheme for intra- and extracellular potentials} }
\label{sec:VC:EMI}
\index{Ephaptic effects}
Ephaptic effects refers to the phenomenon where the extracellular potential affects the membrane potential dynamics of neurons. The possible importance of ephaptic effects has been the topic of many studies, addressing in various ways how extracellular electric fields may affect neuronal firing or signal propagation in axons (see e.g., \cite**{clark1970,Rall1977,Holt1999,Bokil2001,anastassiou2010,anastassiou2015,Goldwyn2016,capllonch2020,ruffini2020}). 

Most of these studies have been based on some simplified approximations as to how evoked fields from one neuron affects other neurons, and less focus has been put on how the presence of ephaptic effects will affect the extracellular potential itself. Rigorous modeling of this, requires that the intra- and extracellular dynamics are modeled simultaneously on a unified framework based on VC theory. Such a framework exists \cite**{Krassowska1994,Agudelo-Toro2013,Tveito 2017}, and was in a recent publication referred to as the extracellular-membrane-intracellular (EMI) framework \cite**{Tveito2017}. 

We here only describe very briefly the essence of the EMI framework. It is based on (Ohmic) current conservation in the intra- and extracelluar spaces, so that:
\begin{equation}
\nabla \cdot \sigma_r \nabla \phi_r = 0,
\label{eq:VC:EMI}
\end{equation}
where $r$ takes the indexes $i$ (intracellular space) or $e$ (extracellular space). The intra- and extracellular dynamics are coupled through suitable boundary condictions at the membrane, making sure that a current \textit{entering} the membrane (normal component) at one side of the membrane, is constrained to be identical to the current \textit{leaving} the membrane (negative normal component) on the opposite side \cite**{Krassowska1994}. These entering and leaving currents are in turn determined by a set of mechanisms that jointly determine the transmembrane current $I_m$. In previous numerical implementations of the EMI framework, the membrane currents were modeled with Hodgkin-Huxley like kinetics \cite**{Agudelo-Toro2013,Tveito2017}. 

Compared to the two-step MC+VC framework, EMI has the disadvantage that it is computationally expensive. In the MC + VC scheme, which uses volume conduction modeling only for the extracellular space, $\phi_e$ can be computed as an analytical function of the transmembrane neural currents (cf. Chapter \ref{sec:VC}). Using EMI, analytical examples of solutions can only be obtained for idealized scenarios \cite**{Krassowska1994}, while general EMI applications require that both the intra- and extracellular spaces are spatially resolved and their dynamics computed on a numerical framework \cite**{Agudelo-Toro2013,Tveito2017}. 

Using EMI to simulate larger systems with realistic morphologies would probably exceed the capacity of today's computers. However, EMI has been used to perform a systematic exploration of the inaccuracies induced when ignoring ephaptic effects in a small system of neurons represented with stylized geometries  \cite**{Tveito2017}. 

There exist even more advanced framework than EMI, which, in addition to accounting for ephaptic effects, also account for effects of changing ion concentrations. We will talk briefly of this in Chapter \ref{sec:Eldiff}, where we consider electrodiffusive transports in brain tissue.